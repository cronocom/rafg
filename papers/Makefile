# papers/Makefile
# Flexible LaTeX compilation with automatic versioning
# Author: Yamil Rodriguez Montana

# ============================================================================
# CONFIGURATION
# ============================================================================

# Main paper filename (without .tex extension)
PAPER = RAGF_v2_3

# Output version (change this when you want a new version)
# Examples: v2_4, v2_5, v3_0, final, camera_ready, submission
VERSION = v2_4

# Output filename (constructed automatically)
OUTPUT = $(PAPER)_$(VERSION).pdf

# LaTeX compiler options
LATEX = pdflatex
LATEX_FLAGS = -interaction=nonstopmode -file-line-error
BIBTEX = bibtex

# ============================================================================
# TARGETS
# ============================================================================

.PHONY: all clean cleanall view help watch draft final

# Default target
all: $(OUTPUT)
	@echo ""
	@echo "‚úÖ Compilation successful!"
	@echo "üìÑ Output: $(OUTPUT)"
	@echo ""

# Main compilation (4-pass for complete bibliography and references)
$(OUTPUT): $(PAPER).tex
	@echo "üìù Starting compilation of $(PAPER).tex ‚Üí $(OUTPUT)"
	@echo ""
	@echo "Pass 1/4: Initial compilation..."
	@$(LATEX) $(LATEX_FLAGS) $(PAPER).tex | grep -i "error" || true
	@echo ""
	@echo "Pass 2/4: Processing bibliography..."
	@$(BIBTEX) $(PAPER) | grep -i "error" || true
	@echo ""
	@echo "Pass 3/4: Resolving citations..."
	@$(LATEX) $(LATEX_FLAGS) $(PAPER).tex | grep -i "error" || true
	@echo ""
	@echo "Pass 4/4: Final compilation..."
	@$(LATEX) $(LATEX_FLAGS) $(PAPER).tex | grep -i "error" || true
	@echo ""
	@if [ -f $(PAPER).pdf ]; then \
		mv $(PAPER).pdf $(OUTPUT); \
		echo "‚úÖ Successfully created: $(OUTPUT)"; \
	else \
		echo "‚ùå Compilation failed. Check $(PAPER).log for errors."; \
		exit 1; \
	fi

# Quick draft (single pass, faster for iterating)
draft:
	@echo "üìù Quick draft compilation..."
	@$(LATEX) $(LATEX_FLAGS) $(PAPER).tex
	@if [ -f $(PAPER).pdf ]; then \
		mv $(PAPER).pdf $(PAPER)_draft.pdf; \
		echo "‚úÖ Draft created: $(PAPER)_draft.pdf"; \
	fi

# Full compilation without moving (keeps PAPER.pdf)
final:
	@echo "üìù Final compilation (keeping original filename)..."
	@$(LATEX) $(LATEX_FLAGS) $(PAPER).tex
	@$(BIBTEX) $(PAPER)
	@$(LATEX) $(LATEX_FLAGS) $(PAPER).tex
	@$(LATEX) $(LATEX_FLAGS) $(PAPER).tex
	@echo "‚úÖ Final PDF: $(PAPER).pdf"

# Clean temporary files
clean:
	@echo "üßπ Cleaning build artifacts..."
	@rm -f *.aux *.log *.bbl *.blg *.out *.toc *.lof *.lot *.fls *.fdb_latexmk *.synctex.gz
	@echo "‚úÖ Cleaned"

# Clean everything including PDFs
cleanall: clean
	@echo "üóëÔ∏è  Removing all generated PDFs..."
	@rm -f $(PAPER)*.pdf
	@echo "‚úÖ All clean"

# Compile and open
view: all
	@echo "üëÄ Opening $(OUTPUT)..."
	@open $(OUTPUT)

# Watch for changes and recompile (requires fswatch)
watch:
	@if command -v fswatch >/dev/null 2>&1; then \
		echo "üëÄ Watching $(PAPER).tex for changes..."; \
		echo "Press Ctrl+C to stop"; \
		fswatch -o $(PAPER).tex | while read; do \
			clear; \
			echo "üîÑ File changed, recompiling..."; \
			make draft; \
		done; \
	else \
		echo "‚ùå fswatch not installed. Install with: brew install fswatch"; \
	fi

# Show help
help:
	@echo ""
	@echo "üìö RAGF Paper Compilation Makefile"
	@echo "=================================="
	@echo ""
	@echo "Configuration:"
	@echo "  PAPER   = $(PAPER)"
	@echo "  VERSION = $(VERSION)"
	@echo "  OUTPUT  = $(OUTPUT)"
	@echo ""
	@echo "Available targets:"
	@echo "  make          - Full 4-pass compilation ‚Üí $(OUTPUT)"
	@echo "  make draft    - Quick single-pass ‚Üí $(PAPER)_draft.pdf"
	@echo "  make final    - Full compilation keeping $(PAPER).pdf"
	@echo "  make view     - Compile and open PDF"
	@echo "  make clean    - Remove temporary build files"
	@echo "  make cleanall - Remove all generated files (including PDFs)"
	@echo "  make watch    - Auto-recompile on file changes (requires fswatch)"
	@echo "  make help     - Show this help message"
	@echo ""
	@echo "Version Management:"
	@echo "  To create a new version, edit the VERSION variable:"
	@echo "    make VERSION=v2_5"
	@echo "    make VERSION=final"
	@echo "    make VERSION=camera_ready"
	@echo ""
	@echo "Examples:"
	@echo "  make                    ‚Üí Creates $(OUTPUT)"
	@echo "  make VERSION=v2_5       ‚Üí Creates RAGF_v2_3_v2_5.pdf"
	@echo "  make VERSION=submission ‚Üí Creates RAGF_v2_3_submission.pdf"
	@echo ""

# ============================================================================
# ADVANCED: Multiple versions at once
# ============================================================================

.PHONY: versions

versions:
	@echo "üì¶ Creating multiple versions..."
	@$(MAKE) VERSION=draft
	@$(MAKE) VERSION=review
	@$(MAKE) VERSION=final
	@echo "‚úÖ Created: $(PAPER)_draft.pdf, $(PAPER)_review.pdf, $(PAPER)_final.pdf"
